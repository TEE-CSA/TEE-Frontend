<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1 class="text1">User Score: <span id="userScoreFib">500</span></h1>
    <h1 class="text2">Amount Bet: <span id="betAmountFib">0</span></h1>

    <div id="track">
        <div class="lane">
            <span class="car-label" id="carLabel1">For Loop</span>
            <img class="race-car1" src="https://github.com/TEE-CSA/TEEBackend/assets/109186517/0fe7001f-0d2e-40fc-bdd1-9b82373862f5" alt="Car 1">
        </div>
        <div class="lane" style="top: 25%;">
            <span class="car-label" id="carLabel2">While Loop</span>
            <img class="race-car2" src="https://github.com/TEE-CSA/TEEBackend/assets/109186517/6d9bc8e3-8c8e-4854-8194-0b5fdacad24b" alt="Car 2">
        </div>
        <div class="lane" style="top: 50%;">
            <span class="car-label" id="carLabel3">Recursion</span>
            <img class="race-car3" src="https://github.com/TEE-CSA/TEEBackend/assets/109186517/3976c85c-ae57-43a0-9331-1e10bf51d29f" alt="Car 3">
        </div>
        <div class="lane1" style="top: 75%">
            <span class="car-label" id="carLabel4">Matrix</span>
            <img class="race-car4" src="https://github.com/TEE-CSA/TEEBackend/assets/109186517/7ad3a783-5957-4979-81c0-33619a9b4ef4" alt="Car 4">
        </div>
        <div class="finish">
            <span class="finish-text">Finish</span>
        </div>
    </div>

    <form id="lengthForm">
        <label for="length">Length of Fibonacci Numbers</label>
        <input type="number" id="length" min="1" value="1">
    </form>

    <input type="number" id="fibBetInput" placeholder="Enter bet amount" />
    <button id="betBtnFib" onclick="placeBetFib()">Place Bet</button>
    <button id="startBtn" onclick="startFibonacciRace()">Start Fibonacci Race</button>
    <button id="resetBtn" onclick="resetRace()">Reset Race</button>

    <script>
        let userScoreFib = 500; // Initial user score for Fibonacci race
        let betAmountFib = 0;   // Initial bet amount for Fibonacci race
        let raceResultFib;

        async function startFibonacciRace(resultFib) {
            try {
                // Fetch algorithm times from the backend
                const length = document.getElementById('length').value;
                const response = await fetch(`http://localhost:8085/api/fibonacci/speeds?length=${length}`);
                const algorithmTimes = await response.json();

                // Calculate the duration for each algorithm
                const duration = 4000; // 4 seconds for animation
                const car1Duration = algorithmTimes["forLoopFibonacci"]["time"];
                const car2Duration = algorithmTimes["whileLoopFibonacci"]["time"];
                const car3Duration = algorithmTimes["recursionFibonacci"]["time"];
                const car4Duration = algorithmTimes["matrixFibonacci"]["time"];

                // Set the animation duration for each car
                document.querySelector(".race-car1").style.transitionDuration = car1Duration + "ms";
                document.querySelector(".race-car2").style.transitionDuration = car2Duration + "ms";
                document.querySelector(".race-car3").style.transitionDuration = car3Duration + "ms";
                document.querySelector(".race-car4").style.transitionDuration = car4Duration + "ms";

                // Start the race by applying the transform property
                document.querySelector(".race-car1").style.transform = "translateX(970px)";
                document.querySelector(".race-car2").style.transform = "translateX(970px)";
                document.querySelector(".race-car3").style.transform = "translateX(970px)";
                document.querySelector(".race-car4").style.transform = "translateX(970px)";

                setTimeout(() => {
                    if (raceResultFib) {
                        const winLossMessage = raceResultFib.didUserWin ? `You won ${betAmountFib * 2} points!` : `You lost ${betAmountFib} points.`;
                        alert(`Race finished! Winning algorithm: ${raceResultFib.selectedAlgorithm}. ${winLossMessage} Fun Fact: ${raceResultFib.funFact}`);
                        userScoreFib += raceResultFib.didUserWin ? betAmountFib * 2 : -betAmountFib;
                        document.getElementById("userScoreFib").textContent = userScoreFib;
                    }
                }, Math.max(...Object.values(algorithmTimes)) * 4000);
            } catch (error) {
                console.error('Error fetching algorithm times:', error);
            }
            try {
                await new Promise(resolve => setTimeout(resolve, Math.max(...Object.values(algorithmTimes)) * 4000));
                const resultTable = document.createElement("table");
                resultTable.innerHTML = `
                    <tr>
                        <th>Algorithm</th>
                        <th>Time (ms)</th>
                        <th>Iterations</th>
                        <th>Time Complexity</th>
                    </tr>
                    <tr>
                        <td>For Loop</td>
                        <td>${algorithmTimes["forLoopFibonacci"]["time"]}</td>
                        <td>${algorithmTimes["forLoopFibonacci"]["iterations"]}</td>
                        <td>O(n)</td>
                    </tr>
                    <tr>
                        <td>While Loop</td>
                        <td>${algorithmTimes["whileLoopFibonacci"]["time"]}</td>
                        <td>${algorithmTimes["whileLoopFibonacci"]["iterations"]}</td>
                        <td>O(n)</td>
                    </tr>
                    <tr>
                        <td>Recursion</td>
                        <td>${algorithmTimes["recursionFibonacci"]["time"]}</td>
                        <td>${algorithmTimes["recursionFibonacci"]["iterations"]}</td>
                        <td>O(n^2)</td>
                    </tr>
                    <tr>
                        <td>Matrix</td>
                        <td>${algorithmTimes["matrixFibonacci"]["time"]}</td>
                        <td>${algorithmTimes["matrixFibonacci"]["iterations"]}</td>
                        <td>O(log(n))</td>
                    </tr>
                `;

                // Append the table to the body or another container
                document.body.appendChild(resultTable);

            } catch (error) {
                console.error('Error fetching algorithm times:', error);
            }
        }
        function resetRace() {
            document.querySelector(".race-car1").style.transform = "translateX(0)";
            document.querySelector(".race-car2").style.transform = "translateX(0)";
            document.querySelector(".race-car3").style.transform = "translateX(0)";
            document.querySelector(".race-car4").style.transform = "translateX(0)";
            document.getElementById("betInput").value = '';
            document.getElementById("length").value = '1';
            betAmountFib = 0;
            document.getElementById("betAmountFib").textContent = betAmountFib;
        }

        async function placeBetFib() {
            const betInputValue = parseInt(document.getElementById("fibBetInput").value);
            if (isNaN(betInputValue) || betInputValue <= 0 || betInputValue > userScoreFib) {
                alert("Invalid bet amount for Fibonacci race");
                return;
            }

            betAmountFib = betInputValue;
            document.getElementById("betAmountFib").textContent = betAmountFib;

            try {
                const response = await fetch(`http://localhost:8085/api/fibonacci/bet?betAmount=${betAmountFib}&startingPoints=${userScoreFib}`);
                raceResultFib = await response.json(); // Store the race result
                // Do not start the race here. The race will start when "Start Fibonacci Race" button is clicked.
            } catch (error) {
                console.error('Error placing bet for Fibonacci race:', error);
            }
        }
    </script>
</body>